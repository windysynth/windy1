<!DOCTYPE html>
<html>
<head>
    <title>Windy1 Synthesizer Patch Editor</title>
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Rubik">
    <link rel="stylesheet" href="style.css">
    <script src="bundle.js"></script>
    <script src="term.js"></script>
</head>
<body>
    <div class="terminal-settings">
        Serial port speed:
        <select name="speed" id="SerialSpeed">
            <option value="115200">115200</option>
            <option value="1200">1200</option>
            <option value="2400">2400</option>
            <option value="4800">4800</option>
            <option value="9600">9600</option>
            <option value="19200">19200</option>
            <option value="38400">38400</option>
            <option value="57600">57600</option>
            <option value="115200">115200</option>
        </select>
        <button id="SerialConnectButton" type="button" disabled>Connect</button>
        Powered by <a href="https://github.com/benc-uk/touchmidi" target="_blank">TouchMIDI</a> and <a href="https://github.com/rafaelaroca/web-serial-terminal"target="_blank">web-serial-terminal</a>.
        MIDI channel:
        <select name="midich" id="MidiChannel">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3/option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
        </select>
    </div>
    <div class="header">
        <h2>Windy1 Synthesizer Patch Editor</h2>
        <h3>(c)02.2025 <a href="https://www.hexefx.com" target="_blank">www.hexefx.com</a></h3>
    </div>
  
    <!-- 

    -->
<div class="controls">
        <group-column margin="0.3" border colour="#333333">
            <group-column margin="0.3" border colour="#181818">
                <group-row>
                    <p>   Oscillator 1 </p>
                </group-row>			
                <group-row>
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                            <midi-encoder label="Oct\n%v" chan="1" nrpn="0,64" min="61" max="67" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Semi\n%v" chan="1" nrpn="1,64" min="52" max="76" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                        </group-row>			
                        <group-row>
                            <midi-encoder label="Cents\n%v" chan="1" nrpn="2,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Beat\n%v" chan="1" nrpn="3,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                            <midi-slider label="Saw\n%v" chan="1" nrpn="5,64" colour="B3E5FC" label-scale="1.5"></midi-slider>
                            <midi-slider label="Tri\n%v" chan="1" nrpn="6,64" colour="B3E5FC" label-scale="1.5"></midi-slider>
                            <midi-slider label="Pulse\n%v" chan="1" nrpn="7,64" colour="B3E5FC" label-scale="1.5"></midi-slider>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                            <midi-button colour="#101010" label="Pulse\nWidth" label-scale="0.75"></midi-button>
                            <midi-encoder label="PWM\nFreq\n%v" chan="1" nrpn="9,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Sweep\nTime\n%v" chan="1" nrpn="12,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                        </group-row>			
                        <group-row>
                            <midi-encoder label="Pule\nWidth\n%v" chan="1" nrpn="8,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Pwm\nDepth\n%v" chan="1" nrpn="10,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Sweep\nDepth\n%v" chan="1" nrpn="11,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#555555">
                        <group-row>
                            <midi-encoder label="Breath\nAttain\n%v" chan="1" nrpn="14,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Breath\nThresh\n%v" chan="1" nrpn="16,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                        </group-row>			
                        <group-row>
                            <midi-encoder label="Breath\nDepth\n%v" chan="1" nrpn="13,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Breath\nCurve\n%v" chan="1" nrpn="15,64" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#555555">
                        <group-row>
                            <midi-slider vertical label="Level\n%v" chan="1" nrpn="17,64" colour="B3E5FC" label-scale="1.0"></midi-slider>
                        </group-row>			
                    </group-column>
                </group-row>			
                <group-row>
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                </group-row>			
                <group-row>
                    <p>   Oscillator 2 </p>
                </group-row>			
                <group-row>
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                            <midi-encoder label="Oct\n%v" chan="1" nrpn="0,65" min="61" max="67" value="64" value-offset="-64" colour="#B3E5FC" ></midi-encoder>
                            <midi-encoder label="Semi\n%v" chan="1" nrpn="1,65" min="52" max="76" value="64" colour="#B3E5FC" ></midi-encoder>
                        </group-row>			
                        <group-row>
                            <midi-encoder label="Cents\n%v" chan="1" nrpn="2,65" colour="#B3E5FC" value="64" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Beat\n%v" chan="1" nrpn="3,65" colour="#B3E5FC" value="64" label-scale="0.8"></midi-encoder>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row grow="2">
                            <midi-slider label="Saw\n%v" chan="1" nrpn="5,65" colour="F08080" label-scale="1.5"></midi-slider>
                            <midi-slider label="Tri\n%v" chan="1" nrpn="6,65" colour="80F080" label-scale="1.5"></midi-slider>
                            <midi-slider label="Pulse\n%v" chan="1" nrpn="7,65" colour="8080F0" label-scale="1.5"></midi-slider>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                            <midi-button colour="#101010" label="Pulse\nWidth" label-scale="0.75"></midi-button>
                            <midi-encoder label="PWM\nFreq\n%v" chan="1" nrpn="9,65" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Sweep\nTime\n%v" chan="1" nrpn="12,65" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                        </group-row>			
                        <group-row>
                            <midi-encoder label="Pule\nWidth\n%v" chan="1" nrpn="8,65" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Pwm\nDepth\n%v" chan="1" nrpn="10,65" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Sweep\nDepth\n%v" chan="1" nrpn="11,65" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#555555">
                        <group-row>
                            <midi-encoder label="Breath\nAttain\n%v" chan="1" nrpn="14,65" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Breath\nThresh\n%v" chan="1" nrpn="16,65" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                        </group-row>			
                        <group-row>
                            <midi-encoder label="Breath\nDepth\n%v" chan="1" nrpn="13,65" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                            <midi-encoder label="Breath\nCurve\n%v" chan="1" nrpn="15,65" colour="#B3E5FC" label-scale="0.8"></midi-encoder>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#555555">
                        <group-row>
                            <midi-slider vertical label="Level\n%v" chan="1" nrpn="17,65" colour="B3E5FC" label-scale="1.0"></midi-slider>
                        </group-row>			
                    </group-column>
                </group-row>			
                <group-row>
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                    <group-column margin="0.3" border colour="#101010">
                    </group-column>			
                    <!-- <midi-button nrpn="6,81" toggle value="1" value-off="0" colour="#B3E5FC" label="XFade" label-scale="0.5" ></midi-button>  -->
                    <midi-slider vertical nrpn="6,81" min="0" max="1" colour="#B3E5FC" label="XFade" label-scale="0.5" ></midi-button>
                </group-row>			
                <group-row>
                    <p>   Oscillator Filter 1 </p>
                </group-row>			
                <group-row>
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                </group-row>			
                <group-row>
                    <p>   Oscillator Filter 2 </p>
                </group-row>			
                <group-row>
                    <midi-button nrpn="3,81" toggle value="0" value-off="1" colour="#B3E5FC" label="Link" label-scale="0.5"></midi-button>
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                    <group-column margin="0.3" border colour="#333333">
                        <group-row>
                        </group-row>			
                    </group-column>			
                </group-row>			
            </group-column>			
        </group-column>			
</div>
<div class="term-wrapper">
    <div id="term"></div>
</div>
    <div class="footer"></div>
</body>

<script>
    var term;
    function calculate_size(win) {
        var cols = Math.max(80, Math.min(150, (win.innerWidth - 280) / 7)) | 0;
        var rows = Math.max(10, Math.min(80, (win.innerHeight - 180) / 12)) | 0;
        return [cols, rows];
    }
    (function () {
        window.onload = function () {

            var size = calculate_size(self);
            term = new Terminal({
                cols: 80,
                rows: 8,
                useStyle: false,
                screenKeys: true,
                cursorBlink: false
            });
            term.innerText
            term.open(document.getElementById("term"));
        };
        window.addEventListener('resize', function () {
            var size = calculate_size(self);
            term.resize(size[0], size[1]);
        });
    }).call(this);
    /*
     * Web Serial API (Google Chrome)
     *
     * Useful information used to this implementation:
     * https://github.com/svendahlstrand/web-serial-api/
     * https://dev.to/unjavascripter/the-amazing-powers-of-the-web-web-serial-api-3ilc
     *
     */
    const connectButton = document.getElementById('SerialConnectButton');
    let port;

    if ('serial' in navigator) {
        connectButton.addEventListener('click', function () {
            if (port) {
                term.write('\x1b[31mDisconnected from Serial Port\x1b[m\r\n');
                port.close();
                port = undefined;
                connectButton.innerText = 'Connect';
                document.getElementById('SerialSpeed').disabled = false;
            }
            else {
                connectButton.innerText = 'Disconnect';
                getReader();
            }
        });
        connectButton.disabled = false;
    }
    else {
        const error = document.createElement('p');
        error.innerHTML = '<p>Support for Serial Web API not enabled. Please enable it using chrome://flags/ and enable Experimental Web Platform fetures</p>';
    }
    let lineBuffer = '';
    let latestValue = 0;
    async function serialWrite(data) {
        encoder = new TextEncoder();
        const dataArrayBuffer = encoder.encode(data);

        if (port && port.writable) {
            const writer = port.writable.getWriter();
            writer.write(dataArrayBuffer);
            writer.releaseLock();
        }
    }
    async function getReader() {
        port = await navigator.serial.requestPort({});
        var e = document.getElementById("SerialSpeed");
        var strSpd = e.options[e.selectedIndex].value;

        var speed = parseInt(strSpd);
        await port.open({ baudRate: [speed] });
        document.getElementById('SerialSpeed').disabled = true;
        connectButton.innerText = 'Disconnect';
        const appendStream = new WritableStream({
            write(chunk) {
                term.write(chunk);
            }
        });
        port.readable
            .pipeThrough(new TextDecoderStream())
            .pipeTo(appendStream);
        term.on('data', function (data) {
            serialWrite(data);
        });
    }
</script>

</html>
